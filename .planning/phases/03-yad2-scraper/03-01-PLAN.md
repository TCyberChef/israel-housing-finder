---
phase: 03-yad2-scraper
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260213020000_add_scraper_fields.sql
autonomous: true

must_haves:
  truths:
    - "listings table has is_active column defaulting to true"
    - "listings table has last_seen column for tracking scrape freshness"
    - "listings table has dedupe_hash column with unique constraint"
  artifacts:
    - path: "supabase/migrations/20260213020000_add_scraper_fields.sql"
      provides: "Adds scraper-required columns to listings table"
      contains: "alter table public.listings"
      min_lines: 20
  key_links:
    - from: "supabase/migrations/20260213020000_add_scraper_fields.sql"
      to: "public.listings"
      via: "ALTER TABLE ADD COLUMN"
      pattern: "add column (is_active|last_seen|dedupe_hash)"
---

<objective>
Add scraper-required columns to listings table for deduplication and staleness tracking.

Purpose: Extend Phase 2 schema with columns needed for scraper operations before implementing scraper logic.
Output: Migration that adds is_active, last_seen, and dedupe_hash columns to listings table.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@supabase/migrations/20260213010445_create_core_schema.sql
</context>

<tasks>

<task type="auto">
  <name>Create migration to add scraper fields</name>
  <files>supabase/migrations/20260213020000_add_scraper_fields.sql</files>
  <action>
    Create supabase/migrations/20260213020000_add_scraper_fields.sql:

    **Add three columns to listings table:**

    1. is_active boolean:
       - Default: true
       - Not null
       - Used to mark listings as active/stale
       - When listings disappear from source for 7+ days, set to false

    2. last_seen timestamptz:
       - Not null
       - Default: now()
       - Updated every time scraper sees this listing
       - Used to calculate staleness (current_time - last_seen > 7 days)

    3. dedupe_hash text:
       - Unique constraint
       - Not null
       - Stores SHA-256 hash of (address, rooms, size_sqm)
       - Used for upsert conflict detection (onConflict: 'dedupe_hash')
       - Check constraint: length(dedupe_hash) = 64 (SHA-256 hex length)

    **Create index:**
    - idx_listings_dedupe_hash on dedupe_hash column (for upsert performance)
    - idx_listings_last_seen on last_seen column (for stale marking queries)

    **Migration structure:**
    ```sql
    -- Add columns
    alter table public.listings
      add column is_active boolean not null default true,
      add column last_seen timestamptz not null default now(),
      add column dedupe_hash text;

    -- Add unique constraint after column exists
    alter table public.listings
      add constraint unique_dedupe_hash unique (dedupe_hash),
      add constraint check_dedupe_hash_length check (length(dedupe_hash) = 64);

    -- Create indexes
    create index idx_listings_dedupe_hash on public.listings(dedupe_hash);
    create index idx_listings_last_seen on public.listings(last_seen desc);

    -- Add comments
    comment on column public.listings.is_active is 'Listing active status; set to false when not seen for 7+ days';
    comment on column public.listings.last_seen is 'Timestamp of most recent scrape seeing this listing';
    comment on column public.listings.dedupe_hash is 'SHA-256 hash of (address, rooms, size_sqm) for deduplication';
    ```

    **Note:** Migration filename uses timestamp format matching Phase 2 convention. Dedupe_hash is nullable initially to allow existing rows, but scraper will always set it.
  </action>
  <verify>
    ls supabase/migrations/20260213020000_add_scraper_fields.sql
    grep -q "add column is_active" supabase/migrations/20260213020000_add_scraper_fields.sql
    grep -q "add column last_seen" supabase/migrations/20260213020000_add_scraper_fields.sql
    grep -q "add column dedupe_hash" supabase/migrations/20260213020000_add_scraper_fields.sql
  </verify>
  <done>Migration file exists with is_active, last_seen, and dedupe_hash columns plus indexes</done>
</task>

</tasks>

<verification>
- [ ] Migration file exists at supabase/migrations/20260213020000_add_scraper_fields.sql
- [ ] is_active column added with boolean type and default true
- [ ] last_seen column added with timestamptz type and default now()
- [ ] dedupe_hash column added with text type and unique constraint
- [ ] Indexes created for dedupe_hash and last_seen
- [ ] Check constraint validates dedupe_hash length is 64 characters
</verification>

<success_criteria>
Migration ready to extend listings table:
- is_active boolean column for tracking listing status
- last_seen timestamptz column for staleness detection
- dedupe_hash text column with unique constraint for upsert conflict detection
- Indexes on dedupe_hash and last_seen for query performance
- Migration follows Phase 2 naming convention
</success_criteria>

<output>
After completion, create `.planning/phases/03-yad2-scraper/03-01-SUMMARY.md`
</output>

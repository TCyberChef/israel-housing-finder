---
phase: 03-yad2-scraper
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260213020000_add_scraper_fields.sql
autonomous: true

must_haves:
  truths:
    - "listings table has is_active column defaulting to true"
    - "listings table has last_seen column for tracking scrape freshness"
    - "Existing dedupe_hashes table from Phase 2 is unchanged"
  artifacts:
    - path: "supabase/migrations/20260213020000_add_scraper_fields.sql"
      provides: "Adds is_active and last_seen columns to listings table"
      contains: "alter table public.listings"
      min_lines: 8
  key_links:
    - from: "supabase/migrations/20260213020000_add_scraper_fields.sql"
      to: "public.listings"
      via: "ALTER TABLE ADD COLUMN"
      pattern: "add column (is_active|last_seen)"
---

<objective>
Add scraper-required columns to listings table for staleness tracking.

Purpose: Extend Phase 2 schema with is_active and last_seen columns needed for scraper operations. Phase 2 already provides the separate dedupe_hashes table for deduplication - that table is used as-is.
Output: Migration that adds is_active and last_seen columns to listings table.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@supabase/migrations/20260213010445_create_core_schema.sql
</context>

<tasks>

<task type="auto">
  <name>Create migration to add scraper fields</name>
  <files>supabase/migrations/20260213020000_add_scraper_fields.sql</files>
  <action>
    Create supabase/migrations/20260213020000_add_scraper_fields.sql:

    **Add two columns to listings table:**

    1. is_active boolean:
       - Default: true
       - Not null
       - Used to mark listings as active/stale
       - When listings disappear from source for 7+ days, set to false

    2. last_seen timestamptz:
       - Not null
       - Default: now()
       - Updated every time scraper sees this listing
       - Used to calculate staleness (current_time - last_seen > 7 days)

    **Create index:**
    - idx_listings_last_seen on last_seen column (for stale marking queries)
    - idx_listings_is_active on is_active column (for filtering active listings)

    **Migration structure:**
    ```sql
    -- Add scraper tracking columns
    alter table public.listings
      add column is_active boolean not null default true,
      add column last_seen timestamptz not null default now();

    -- Create indexes for scraper queries
    create index idx_listings_last_seen on public.listings(last_seen desc);
    create index idx_listings_is_active on public.listings(is_active) where is_active = true;

    -- Add comments
    comment on column public.listings.is_active is 'Listing active status; set to false when not seen for 7+ days';
    comment on column public.listings.last_seen is 'Timestamp of most recent scrape seeing this listing';
    ```

    **Note:** Deduplication uses the existing dedupe_hashes table from Phase 2 (content_hash + listing_id FK). No dedupe_hash column needed on listings table.
  </action>
  <verify>
    ls supabase/migrations/20260213020000_add_scraper_fields.sql
    grep -q "add column is_active" supabase/migrations/20260213020000_add_scraper_fields.sql
    grep -q "add column last_seen" supabase/migrations/20260213020000_add_scraper_fields.sql
  </verify>
  <done>Migration file exists with is_active and last_seen columns plus indexes</done>
</task>

</tasks>

<verification>
- [ ] Migration file exists at supabase/migrations/20260213020000_add_scraper_fields.sql
- [ ] is_active column added with boolean type and default true
- [ ] last_seen column added with timestamptz type and default now()
- [ ] Indexes created for last_seen and is_active
- [ ] No dedupe_hash column on listings table (uses existing dedupe_hashes table)
</verification>

<success_criteria>
Migration ready to extend listings table:
- is_active boolean column for tracking listing status
- last_seen timestamptz column for staleness detection
- Indexes on last_seen and is_active for query performance
- Existing dedupe_hashes table from Phase 2 remains unchanged
- Migration follows Phase 2 naming convention
</success_criteria>

<output>
After completion, create `.planning/phases/03-yad2-scraper/03-01-SUMMARY.md`
</output>

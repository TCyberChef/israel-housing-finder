---
phase: 03-yad2-scraper
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - package.json
  - tsconfig.scraper.json
  - src/scrapers/types.ts
  - src/scrapers/utils/hash.ts
  - src/scrapers/utils/logger.ts
autonomous: true

must_haves:
  truths:
    - "TypeScript scraper code compiles without errors"
    - "Hash generation produces consistent SHA-256 hashes for same input"
    - "Listing type uses size_sqm field matching database schema"
  artifacts:
    - path: "tsconfig.scraper.json"
      provides: "TypeScript config for Node.js scraper context"
      contains: "module.*commonjs"
    - path: "src/scrapers/types.ts"
      provides: "Listing type definitions matching Phase 2 schema"
      exports: ["Listing", "ScraperResult"]
      min_lines: 20
    - path: "src/scrapers/utils/hash.ts"
      provides: "SHA-256 hash generation using size_sqm for deduplication"
      exports: ["generateDedupeHash"]
      min_lines: 10
    - path: "src/scrapers/utils/logger.ts"
      provides: "Structured logging utility"
      exports: ["log"]
      min_lines: 15
    - path: "package.json"
      contains: "puppeteer-extra"
  key_links:
    - from: "src/scrapers/utils/hash.ts"
      to: "node:crypto"
      via: "import createHash"
      pattern: "createHash.*sha256"
    - from: "src/scrapers/utils/hash.ts"
      to: "size_sqm"
      via: "hash generation parameter"
      pattern: "size_sqm"
    - from: "package.json"
      to: "puppeteer-extra"
      via: "dependencies"
      pattern: "puppeteer-extra.*\\^3\\.3"
---

<objective>
Set up TypeScript scraper infrastructure with Puppeteer, type definitions, and shared utilities.

Purpose: Establish the foundation for scraping Yad2 with type safety matching Phase 2 schema, deduplication hashing using size_sqm, and logging before implementing scraper logic.
Output: TypeScript config, type definitions with size_sqm field, hash utility, logger, and installed dependencies ready for scraper implementation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-yad2-scraper/03-RESEARCH.md
@.planning/phases/03-yad2-scraper/03-01-SUMMARY.md
@supabase/migrations/20260213010445_create_core_schema.sql
@package.json
</context>

<tasks>

<task type="auto">
  <name>Install scraper dependencies</name>
  <files>package.json</files>
  <action>
    Install scraper dependencies:
    - puppeteer-extra ^3.3.6 (headless browser with plugin support)
    - puppeteer-extra-plugin-stealth ^2.11.2 (anti-detection evasion)
    - @supabase/supabase-js already installed (database client)
    - tsx ^4.x (TypeScript execution for local testing)
    - @types/node (TypeScript Node.js types)

    Use production dependencies for puppeteer/stealth (needed in GitHub Actions), devDependencies for tsx/@types/node (local only).

    Run: npm install puppeteer-extra puppeteer-extra-plugin-stealth
    Run: npm install -D tsx @types/node
  </action>
  <verify>npm list puppeteer-extra puppeteer-extra-plugin-stealth tsx @types/node</verify>
  <done>Dependencies installed and appear in package.json with correct versions</done>
</task>

<task type="auto">
  <name>Create TypeScript config for scraper</name>
  <files>tsconfig.scraper.json</files>
  <action>
    Create tsconfig.scraper.json for Node.js scraper context (separate from frontend Vite TypeScript config):
    - Target: ES2022 (modern Node.js 20 support)
    - Module: CommonJS (Node.js default, compatible with puppeteer-extra)
    - ModuleResolution: node
    - Strict: true (type safety)
    - esModuleInterop: true (CommonJS/ESM compatibility)
    - Include: ["src/scrapers/**/*"]
    - OutDir: "dist/scrapers"
    - Types: ["node"]

    This is separate from the frontend tsconfig.json (which uses Vite/ES modules).
  </action>
  <verify>npx tsc --project tsconfig.scraper.json --noEmit (should compile without errors)</verify>
  <done>TypeScript config exists and compiles scraper code with Node.js types</done>
</task>

<task type="auto">
  <name>Create type definitions and utilities</name>
  <files>src/scrapers/types.ts, src/scrapers/utils/hash.ts, src/scrapers/utils/logger.ts</files>
  <action>
    Create three files:

    1. src/scrapers/types.ts - Define TypeScript interfaces matching Phase 2 schema:
       - Listing: { id: string, address: string, city: string, price: number, rooms: number, size_sqm?: number, floor?: number, photos: string[], source_url: string, source_platform: string, source_id: string }
       - ScraperResult: { listings: Listing[], scrapedAt: string, count: number }
       - IMPORTANT: Use size_sqm (not size) to match database schema column name from Phase 2

    2. src/scrapers/utils/hash.ts - SHA-256 hash generation:
       - Export function generateDedupeHash(address: string, rooms: number, size_sqm?: number): string
       - Use Node.js crypto.createHash('sha256')
       - Hash content format: "${address}|${rooms}|${size_sqm || 0}" (matches Phase 2 schema design)
       - Return hex digest
       - IMPORTANT: Parameter must be size_sqm to match database schema

    3. src/scrapers/utils/logger.ts - Structured logging:
       - Export function log(level: 'info' | 'warn' | 'error', message: string, meta?: Record<string, unknown>): void
       - Output JSON: { timestamp: ISO string, level, message, ...meta }
       - Use console.log for info, console.error for error
       - Include process.env.NODE_ENV check (silent in test mode)
  </action>
  <verify>
    npx tsc --project tsconfig.scraper.json --noEmit
    node -e "const { generateDedupeHash } = require('./dist/scrapers/utils/hash.js'); console.log(generateDedupeHash('123 Main St', 3, 80))"
  </verify>
  <done>Type definitions exist with size_sqm field, hash utility generates SHA-256 hashes using size_sqm, logger outputs structured JSON</done>
</task>

</tasks>

<verification>
- [ ] package.json includes puppeteer-extra, puppeteer-extra-plugin-stealth, tsx, @types/node
- [ ] tsconfig.scraper.json compiles without errors
- [ ] src/scrapers/types.ts exports Listing interface with size_sqm field (not size)
- [ ] src/scrapers/types.ts exports ScraperResult interface
- [ ] src/scrapers/utils/hash.ts uses size_sqm parameter (not size)
- [ ] src/scrapers/utils/hash.ts generates consistent SHA-256 hashes
- [ ] src/scrapers/utils/logger.ts outputs structured JSON logs
</verification>

<success_criteria>
TypeScript scraper infrastructure is ready:
- Dependencies installed (puppeteer-extra, stealth plugin, tsx, @types/node)
- TypeScript config for Node.js context compiles successfully
- Type definitions for Listing use size_sqm matching Phase 2 schema
- Hash utility produces SHA-256 hashes using size_sqm for deduplication
- Structured logger outputs JSON logs
</success_criteria>

<output>
After completion, create `.planning/phases/03-yad2-scraper/03-02-SUMMARY.md`
</output>

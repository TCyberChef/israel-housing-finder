---
phase: 03-yad2-scraper
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/scrapers/yad2.ts
  - src/scrapers/utils/retry.ts
autonomous: true

must_haves:
  truths:
    - "Scraper launches headless Chrome with stealth plugin"
    - "Scraper extracts listing data from Yad2 HTML"
    - "Scraper returns structured Listing[] array"
    - "Failed requests retry with exponential backoff"
  artifacts:
    - path: "src/scrapers/yad2.ts"
      provides: "Yad2 scraping implementation"
      exports: ["scrapeYad2"]
      min_lines: 80
    - path: "src/scrapers/utils/retry.ts"
      provides: "Retry logic with exponential backoff"
      exports: ["withRetry"]
      min_lines: 20
  key_links:
    - from: "src/scrapers/yad2.ts"
      to: "puppeteer-extra"
      via: "import puppeteer"
      pattern: "puppeteer\\.launch"
    - from: "src/scrapers/yad2.ts"
      to: "puppeteer-extra-plugin-stealth"
      via: "StealthPlugin"
      pattern: "puppeteer\\.use.*Stealth"
    - from: "src/scrapers/yad2.ts"
      to: "src/scrapers/types.ts"
      via: "import Listing"
      pattern: "import.*Listing.*from.*types"
    - from: "src/scrapers/yad2.ts"
      to: "src/scrapers/utils/retry.ts"
      via: "withRetry wrapper"
      pattern: "withRetry.*page\\.goto"
---

<objective>
Build Yad2 scraper with Puppeteer stealth, HTML parsing, and retry logic.

Purpose: Implement the core scraping logic to extract rental listings from Yad2 with anti-detection evasion and resilient error handling.
Output: Working scraper function that returns structured Listing[] data from Yad2 rental search results.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-yad2-scraper/03-RESEARCH.md
@.planning/phases/03-yad2-scraper/03-01-SUMMARY.md
@src/scrapers/types.ts
@src/scrapers/utils/hash.ts
@src/scrapers/utils/logger.ts
</context>

<tasks>

<task type="auto">
  <name>Create retry utility with exponential backoff</name>
  <files>src/scrapers/utils/retry.ts</files>
  <action>
    Create src/scrapers/utils/retry.ts with generic retry function:

    Export async function withRetry<T>(
      fn: () => Promise<T>,
      maxRetries = 3,
      baseDelay = 1000
    ): Promise<T>

    Implementation:
    - Loop from attempt 0 to maxRetries-1
    - Try executing fn()
    - On success: return result
    - On failure: if last attempt, throw error
    - Otherwise: calculate delay = baseDelay * Math.pow(2, attempt) (exponential backoff)
    - Wait for delay using setTimeout/Promise
    - Retry

    Use TypeScript generics for type safety. No external dependencies (pure TypeScript/Node.js).
  </action>
  <verify>npx tsc --project tsconfig.scraper.json --noEmit</verify>
  <done>Retry utility exists and compiles, implements exponential backoff pattern</done>
</task>

<task type="auto">
  <name>Implement Yad2 scraper with stealth and parsing</name>
  <files>src/scrapers/yad2.ts</files>
  <action>
    Create src/scrapers/yad2.ts with scrapeYad2() function:

    **Imports:**
    - puppeteer from 'puppeteer-extra'
    - StealthPlugin from 'puppeteer-extra-plugin-stealth'
    - { Listing, ScraperResult } from './types'
    - { log } from './utils/logger'
    - { withRetry } from './utils/retry'

    **Setup:**
    - puppeteer.use(StealthPlugin()) before launch
    - Launch browser with args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-dev-shm-usage']
    - headless: true
    - Set viewport: 1920x1080
    - Set user agent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'

    **Scraping logic:**
    - Navigate to: https://www.yad2.co.il/realestate/rent (use withRetry wrapper, 30s timeout, waitUntil: 'networkidle2')
    - Add 3-second delay after page load (rate limiting)
    - Extract listings using page.evaluate():
      - Query selector: '.feeditem' (from research - validate during execution, log warning if empty)
      - For each item, extract:
        - id: data-id attribute
        - address: .address text
        - city: .city text
        - price: .price text (parse numbers only)
        - rooms: .rooms text (parseFloat)
        - size: .size text (parse numbers only, optional)
        - photos: array of img src attributes
        - source_url: item link href or construct from id
        - source_platform: 'yad2' (hardcoded)
        - source_id: same as id
      - Handle missing fields gracefully (use || '' for strings, || 0 for numbers)
    - Filter out items with missing required fields (id, address, city)
    - Log: "Scraped {count} listings from Yad2"
    - Close browser
    - Return { listings, scrapedAt: new Date().toISOString(), count: listings.length }

    **Error handling:**
    - Wrap in try/finally to ensure browser.close()
    - Log errors with context
    - Throw errors after logging (let caller handle)

    **Note:** HTML selectors (.feeditem, .address, etc.) are from 2024 research and may be outdated. During execution, inspect actual Yad2 HTML and update selectors if needed. Document any changes in SUMMARY.
  </action>
  <verify>
    npx tsc --project tsconfig.scraper.json --noEmit
    npx tsx src/scrapers/yad2.ts (add a test harness at bottom: if (require.main === module) { scrapeYad2().then(console.log) })
  </verify>
  <done>Scraper launches browser with stealth, navigates to Yad2, extracts listings, returns structured data</done>
</task>

</tasks>

<verification>
- [ ] src/scrapers/utils/retry.ts implements exponential backoff
- [ ] src/scrapers/yad2.ts uses puppeteer-extra with stealth plugin
- [ ] Browser launches with --disable-dev-shm-usage (GitHub Actions compatibility)
- [ ] Scraper navigates to Yad2 rental page with retry logic
- [ ] page.evaluate() extracts listing data from HTML
- [ ] Listings include all required fields (id, address, city, price, rooms, photos, source_*)
- [ ] Function returns ScraperResult with listings array
- [ ] TypeScript compiles without errors
</verification>

<success_criteria>
Yad2 scraper is functional:
- Retry utility implements exponential backoff for resilient requests
- Scraper launches headless Chrome with stealth plugin
- Scraper navigates to Yad2 rental search page successfully
- HTML parsing extracts listing data (address, price, rooms, photos)
- Function returns structured Listing[] array
- TypeScript types are enforced throughout
</success_criteria>

<output>
After completion, create `.planning/phases/03-yad2-scraper/03-02-SUMMARY.md`
</output>

---
phase: 04-frontend-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/i18n/config.ts
  - src/i18n/locales/he/common.json
  - src/i18n/locales/en/common.json
  - src/lib/leaflet-icons.ts
  - src/main.tsx
autonomous: true

must_haves:
  truths:
    - "Application loads with Hebrew as default language"
    - "User can toggle between Hebrew and English"
    - "RTL layout applies in Hebrew mode"
    - "LTR layout applies in English mode"
    - "Language selection persists across page refresh"
  artifacts:
    - path: "src/i18n/config.ts"
      provides: "i18next configuration with Hebrew/English support"
      exports: ["default"]
      min_lines: 30
    - path: "src/i18n/locales/he/common.json"
      provides: "Hebrew translations for UI labels"
      contains: "header.title"
    - path: "src/i18n/locales/en/common.json"
      provides: "English translations for UI labels"
      contains: "header.title"
    - path: "src/lib/leaflet-icons.ts"
      provides: "Leaflet marker icon configuration for Vite"
      exports: ["default"]
      min_lines: 10
  key_links:
    - from: "src/main.tsx"
      to: "src/i18n/config.ts"
      via: "import before React render"
      pattern: "import.*i18n/config"
    - from: "src/main.tsx"
      to: "src/lib/leaflet-icons.ts"
      via: "import before React render"
      pattern: "import.*leaflet-icons"
---

<objective>
Install and configure internationalization infrastructure with Hebrew/English bilingual support, RTL layout switching, and Leaflet marker icon fixes for Vite bundler.

Purpose: Establish i18n foundation before building UI components
Output: Working language toggle with RTL/LTR switching, Leaflet ready for map components
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-frontend-foundation/04-CONTEXT.md
@.planning/phases/04-frontend-foundation/04-RESEARCH.md
@src/main.tsx
@src/App.tsx
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install i18n and mapping dependencies</name>
  <files>package.json</files>
  <action>
Install required npm packages for internationalization and mapping:

```bash
npm install react-leaflet leaflet react-leaflet-cluster
npm install react-i18next i18next i18next-browser-languagedetector
npm install --save-dev @types/leaflet
```

These packages provide:
- react-leaflet v5.x: React bindings for Leaflet (industry standard mapping library)
- leaflet: Core mapping library with OpenStreetMap support
- react-leaflet-cluster: Marker clustering for performance with many pins
- react-i18next + i18next: React internationalization with RTL support
- i18next-browser-languagedetector: Auto-detect browser language + localStorage persistence
- @types/leaflet: TypeScript definitions

Per RESEARCH.md: These are the standard stack with 2.8M-6M weekly downloads each. No alternatives needed.
  </action>
  <verify>npm list react-leaflet leaflet react-i18next i18next shows all packages installed</verify>
  <done>package.json contains all 5 production dependencies and @types/leaflet in devDependencies</done>
</task>

<task type="auto">
  <name>Task 2: Configure i18next with Hebrew/English and RTL support</name>
  <files>
    src/i18n/config.ts
    src/i18n/locales/he/common.json
    src/i18n/locales/en/common.json
    src/main.tsx
  </files>
  <action>
Set up i18next configuration following Pattern 3 from RESEARCH.md:

**1. Create Hebrew translation file at src/i18n/locales/he/common.json:**
```json
{
  "header": {
    "title": "חיפוש דירות בישראל",
    "languageToggle": "English"
  },
  "map": {
    "loading": "טוען נכסים...",
    "noListings": "לא נמצאו נכסים"
  },
  "listing": {
    "price": "{{price}} ₪/חודש",
    "rooms": "{{count}} חדרים",
    "sqm": "{{size}} מ\"ר",
    "floor": "קומה {{floor}}"
  }
}
```

**2. Create English translation file at src/i18n/locales/en/common.json:**
```json
{
  "header": {
    "title": "Israel Housing Finder",
    "languageToggle": "עברית"
  },
  "map": {
    "loading": "Loading listings...",
    "noListings": "No listings found"
  },
  "listing": {
    "price": "₪{{price}}/month",
    "rooms": "{{count}} rooms",
    "sqm": "{{size}} sqm",
    "floor": "Floor {{floor}}"
  }
}
```

**3. Create i18next config at src/i18n/config.ts:**
```typescript
import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';
import LanguageDetector from 'i18next-browser-languagedetector';
import heCommon from './locales/he/common.json';
import enCommon from './locales/en/common.json';

i18n
  .use(LanguageDetector) // Detects browser language
  .use(initReactI18next)
  .init({
    resources: {
      he: { common: heCommon },
      en: { common: enCommon },
    },
    fallbackLng: 'he', // Hebrew default per CONTEXT.md
    defaultNS: 'common',
    interpolation: {
      escapeValue: false, // React already escapes
    },
    detection: {
      order: ['localStorage', 'navigator'], // localStorage takes priority
      caches: ['localStorage'], // Persist user selection
      lookupLocalStorage: 'i18nextLng',
    },
  });

export default i18n;
```

**4. Import i18n config in src/main.tsx BEFORE React render:**
Add at top of file (before React imports):
```typescript
import './i18n/config';
```

This ensures i18next initializes before React components try to use translations.

Per CONTEXT.md: Hebrew is default, auto-detect from browser, persist to localStorage. Pattern verified in RESEARCH.md.
  </action>
  <verify>
1. cat src/i18n/config.ts shows i18next initialization
2. cat src/i18n/locales/he/common.json contains Hebrew translations
3. cat src/i18n/locales/en/common.json contains English translations
4. grep "import.*i18n/config" src/main.tsx shows import before React
  </verify>
  <done>
i18next configured with Hebrew default, browser detection, localStorage persistence, and both translation files created
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix Leaflet marker icons for Vite bundler</name>
  <files>src/lib/leaflet-icons.ts, src/main.tsx</files>
  <action>
Configure Leaflet marker icon paths to fix broken markers in Vite builds (Pattern 2 from RESEARCH.md):

**1. Create src/lib/leaflet-icons.ts:**
```typescript
// Fix Leaflet default marker icons for Vite/Webpack bundlers
// Source: https://github.com/Leaflet/Leaflet/issues/4968
import L from 'leaflet';
import markerIcon from 'leaflet/dist/images/marker-icon.png';
import markerIcon2x from 'leaflet/dist/images/marker-icon-2x.png';
import markerShadow from 'leaflet/dist/images/marker-shadow.png';

// Remove default icon URL detection (broken in bundlers)
delete (L.Icon.Default.prototype as any)._getIconUrl;

// Explicitly set icon paths
L.Icon.Default.mergeOptions({
  iconUrl: markerIcon,
  iconRetinaUrl: markerIcon2x,
  shadowUrl: markerShadow,
});

export default L;
```

**2. Import in src/main.tsx BEFORE React render (after i18n import):**
```typescript
import './lib/leaflet-icons';
```

**Why this is critical:** Vite bundles marker-icon.png with hashed filenames. Leaflet's auto-detection looks for the original filename and fails with 404 errors. This explicit configuration fixes the paths. Common pitfall per RESEARCH.md Pitfall 2.
  </action>
  <verify>
1. cat src/lib/leaflet-icons.ts shows L.Icon.Default.mergeOptions configuration
2. grep "import.*leaflet-icons" src/main.tsx shows import before React
  </verify>
  <done>Leaflet marker icon paths explicitly configured to work with Vite bundler</done>
</task>

</tasks>

<verification>
1. All dependencies installed: `npm list react-leaflet leaflet react-i18next`
2. i18n config exists and imports correctly: `cat src/i18n/config.ts`
3. Translation files exist with Hebrew/English content
4. main.tsx imports both i18n config and leaflet-icons before React
5. No TypeScript errors: `npm run build` succeeds
</verification>

<success_criteria>
- [ ] package.json lists 5 new production dependencies + @types/leaflet
- [ ] src/i18n/config.ts initializes i18next with Hebrew default and localStorage persistence
- [ ] src/i18n/locales/he/common.json contains Hebrew UI translations
- [ ] src/i18n/locales/en/common.json contains English UI translations
- [ ] src/lib/leaflet-icons.ts fixes marker icon paths for Vite
- [ ] src/main.tsx imports i18n config and leaflet-icons before React render
- [ ] npm run build completes without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-frontend-foundation/04-01-SUMMARY.md`
</output>

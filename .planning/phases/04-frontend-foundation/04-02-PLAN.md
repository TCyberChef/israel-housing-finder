---
phase: 04-frontend-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/cities.ts
  - src/types/listing.ts
  - src/hooks/useListings.ts
autonomous: true

must_haves:
  truths:
    - "Application can fetch active listings from Supabase"
    - "Listings have city-level coordinates for map display"
    - "TypeScript types match database schema"
  artifacts:
    - path: "src/lib/cities.ts"
      provides: "Israeli city to lat/lng coordinate lookup"
      exports: ["CITY_COORDINATES"]
      min_lines: 20
    - path: "src/types/listing.ts"
      provides: "Listing TypeScript interface matching database schema"
      exports: ["Listing"]
    - path: "src/hooks/useListings.ts"
      provides: "React hook to fetch and enrich listings with coordinates"
      exports: ["useListings"]
      min_lines: 30
  key_links:
    - from: "src/hooks/useListings.ts"
      to: "src/lib/supabase.ts"
      via: "Supabase client import"
      pattern: "import.*supabase"
    - from: "src/hooks/useListings.ts"
      to: "src/lib/cities.ts"
      via: "City coordinate enrichment"
      pattern: "CITY_COORDINATES"
    - from: "src/hooks/useListings.ts"
      to: "src/types/listing.ts"
      via: "Type-safe listing data"
      pattern: "Listing"
---

<objective>
Create data layer for listings with city-level geocoding, TypeScript types matching database schema, and React hook for fetching active listings from Supabase.

Purpose: Provide map-ready listing data without full geocoding API (deferred to Phase 9)
Output: useListings hook returning listings with approximate city coordinates
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-frontend-foundation/04-CONTEXT.md
@.planning/phases/04-frontend-foundation/04-RESEARCH.md
@.planning/phases/02-database-core-schema/02-01-SUMMARY.md
@src/lib/supabase.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Israeli cities coordinate lookup table</name>
  <files>src/lib/cities.ts</files>
  <action>
Create a simple city-to-coordinates lookup table for major Israeli cities. This is a temporary solution until Phase 9 adds full address geocoding.

**Create src/lib/cities.ts:**
```typescript
/**
 * Israeli city to approximate coordinates lookup
 * Used for map display until Phase 9 adds full address geocoding
 * Coordinates are city centers from OpenStreetMap
 */

export const CITY_COORDINATES: Record<string, [number, number]> = {
  // Major cities
  'תל אביב': [32.0853, 34.7818],
  'ירושלים': [31.7683, 35.2137],
  'חיפה': [32.7940, 34.9896],
  'ראשון לציון': [31.9730, 34.7925],
  'פתח תקווה': [32.0878, 34.8871],
  'אשדוד': [31.8044, 34.6553],
  'נתניה': [32.3215, 34.8532],
  'באר שבע': [31.2518, 34.7913],
  'בני ברק': [32.0809, 34.8338],
  'חולון': [32.0117, 34.7750],
  'רמת גן': [32.0719, 34.8237],
  'אשקלון': [31.6688, 34.5742],
  'רחובות': [31.8914, 34.8095],
  'בת ים': [32.0167, 34.7500],
  'כפר סבא': [32.1842, 34.9077],
  'הרצליה': [32.1624, 34.8443],
  'חדרה': [32.4344, 34.9197],
  'מודיעין': [31.8969, 35.0095],
  'נצרת': [32.7046, 35.3027],
  'לוד': [31.9514, 34.8989],
  'רעננה': [32.1849, 34.8706],
  'רמלה': [31.9290, 34.8671],

  // Peripheral cities
  'אילת': [29.5577, 34.9519],
  'טבריה': [32.7922, 35.5308],
  'צפת': [32.9658, 35.4983],
  'עכו': [32.9275, 35.0833],
  'קריית שמונה': [33.2074, 35.5692],
  'בית שמש': [31.7530, 34.9895],
  'כרמיאל': [32.9186, 35.2958],
  'יבנה': [31.8786, 34.7361],
  'קריית גת': [31.6103, 34.7642],
  'קריית מוצקין': [32.8364, 35.0747],
  'קריית ביאליק': [32.8372, 35.0872],
  'נהריה': [33.0058, 35.0947],
  'דימונה': [31.0689, 35.0322],
};

/**
 * Get coordinates for a city name
 * Falls back to Israel center if city not found
 */
export function getCityCoordinates(city: string): [number, number] {
  const normalized = city.trim();
  return CITY_COORDINATES[normalized] || [31.5, 34.8]; // Israel center fallback
}
```

**Rationale (Claude's discretion per CONTEXT.md):**
- Database has NO lat/lng columns (geocoding deferred to Phase 9 per Phase 2 decisions)
- Need to show listings on map NOW without external API calls
- City-level coordinates sufficient for Phase 4 browsing
- Listings in same city will cluster naturally
- Phase 9 will add precise address-level geocoding

Major Israeli cities covered (35+ cities where most rental activity occurs). Fallback to Israel center for unknown cities.
  </action>
  <verify>
1. cat src/lib/cities.ts shows CITY_COORDINATES object with 30+ cities
2. grep "תל אביב" src/lib/cities.ts shows Tel Aviv coordinates
3. grep "getCityCoordinates" src/lib/cities.ts shows fallback function
  </verify>
  <done>City coordinate lookup table created with 35+ Israeli cities and fallback to Israel center</done>
</task>

<task type="auto">
  <name>Task 2: Create TypeScript types matching database schema</name>
  <files>src/types/listing.ts</files>
  <action>
Create TypeScript interface matching the database schema from Phase 2.

**Create src/types/listing.ts:**
```typescript
/**
 * Listing type matching Supabase listings table schema
 * Schema defined in: supabase/migrations/20260213010445_create_core_schema.sql
 */

export interface Listing {
  id: string;
  address: string;
  city: string;
  price: number; // Rent price in ILS (shekels)
  rooms: number; // Room count (e.g., 2.5)
  size_sqm: number | null; // Square meters
  floor: number | null;
  photos: string[]; // JSONB array of photo URLs
  sources: Source[]; // JSONB array of platform sources
  description: string | null;
  contact_info: string | null;
  created_at: string; // ISO 8601 timestamp
  updated_at: string; // ISO 8601 timestamp

  // Not in database - enriched by frontend for map display
  latitude?: number;
  longitude?: number;
}

export interface Source {
  platform: string; // e.g., "yad2", "homeless"
  listing_id: string; // Original listing ID from source
  url: string; // Original listing URL
  scraped_at: string; // ISO 8601 timestamp
}

/**
 * Database query result type
 * Before coordinate enrichment
 */
export type ListingRow = Omit<Listing, 'latitude' | 'longitude'>;
```

**Key design choices:**
- Matches Phase 2 schema exactly (see 02-01-SUMMARY.md)
- photos and sources as arrays (JSONB in database)
- price as number (integer in database, shekels)
- rooms as number (numeric(3,1) in database for 2.5 rooms)
- Optional latitude/longitude fields (NOT in database, added by frontend)
- ListingRow type for raw database results before coordinate enrichment
  </action>
  <verify>
1. cat src/types/listing.ts shows Listing interface with all database fields
2. grep "latitude.*longitude" src/types/listing.ts shows optional coordinate fields
3. grep "Source" src/types/listing.ts shows Source interface for sources array
  </verify>
  <done>TypeScript Listing type created matching database schema with optional coordinate enrichment</done>
</task>

<task type="auto">
  <name>Task 3: Create useListings React hook with coordinate enrichment</name>
  <files>src/hooks/useListings.ts</files>
  <action>
Create React hook to fetch active listings from Supabase and enrich with city-level coordinates (Pattern 5 from RESEARCH.md).

**Create src/hooks/useListings.ts:**
```typescript
import { useState, useEffect } from 'react';
import { supabase } from '../lib/supabase';
import { getCityCoordinates } from '../lib/cities';
import type { Listing, ListingRow } from '../types/listing';

interface UseListingsResult {
  listings: Listing[];
  loading: boolean;
  error: Error | null;
}

/**
 * Fetch active listings from Supabase and enrich with city coordinates
 * Uses city-level coordinates until Phase 9 adds precise geocoding
 */
export function useListings(): UseListingsResult {
  const [listings, setListings] = useState<Listing[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<Error | null>(null);

  useEffect(() => {
    async function fetchListings() {
      try {
        // Query active listings from database
        // RLS policy allows public read access per Phase 2
        const { data, error: queryError } = await supabase
          .from('listings')
          .select('*')
          .eq('is_active', true) // Only active listings (added in Phase 3)
          .order('created_at', { ascending: false });

        if (queryError) throw queryError;

        // Enrich with city-level coordinates for map display
        const enrichedListings: Listing[] = (data || []).map((row: ListingRow) => {
          const [latitude, longitude] = getCityCoordinates(row.city);
          return {
            ...row,
            latitude,
            longitude,
          };
        });

        setListings(enrichedListings);
      } catch (err) {
        console.error('Failed to fetch listings:', err);
        setError(err as Error);
      } finally {
        setLoading(false);
      }
    }

    fetchListings();
  }, []); // Empty dependency array - fetch once on mount

  return { listings, loading, error };
}
```

**Design notes:**
- Fetches only is_active=true listings (column added in Phase 3 Plan 01)
- Orders by created_at descending (newest first)
- Maps city name to coordinates using getCityCoordinates lookup
- Uses Supabase anon key (read-only access via RLS per Phase 2)
- Standard React state management pattern (loading, error, data)
- Pattern verified in RESEARCH.md Pattern 5
  </action>
  <verify>
1. cat src/hooks/useListings.ts shows fetchListings function with Supabase query
2. grep "getCityCoordinates" src/hooks/useListings.ts shows coordinate enrichment
3. grep "is_active.*true" src/hooks/useListings.ts shows active-only filter
4. grep "UseListingsResult" src/hooks/useListings.ts shows return type definition
  </verify>
  <done>useListings hook created with Supabase fetch and city-level coordinate enrichment</done>
</task>

</tasks>

<verification>
1. City coordinates table exists: `cat src/lib/cities.ts`
2. TypeScript types exist: `cat src/types/listing.ts`
3. useListings hook exists: `cat src/hooks/useListings.ts`
4. Hook imports Supabase client: `grep "from.*supabase" src/hooks/useListings.ts`
5. Hook imports city coordinates: `grep "getCityCoordinates" src/hooks/useListings.ts`
6. No TypeScript errors: `npm run build` succeeds
</verification>

<success_criteria>
- [ ] src/lib/cities.ts contains 30+ Israeli cities with coordinates
- [ ] src/lib/cities.ts exports getCityCoordinates with fallback to Israel center
- [ ] src/types/listing.ts interface matches Phase 2 database schema
- [ ] src/types/listing.ts includes optional latitude/longitude fields
- [ ] src/hooks/useListings.ts fetches active listings from Supabase
- [ ] src/hooks/useListings.ts enriches listings with city coordinates
- [ ] npm run build completes without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-frontend-foundation/04-02-SUMMARY.md`
</output>

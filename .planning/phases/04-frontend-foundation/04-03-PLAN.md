---
phase: 04-frontend-foundation
plan: 03
type: execute
wave: 2
depends_on: [04-01, 04-02]
files_modified:
  - src/components/Map/LeafletMap.tsx
  - src/components/Map/ClusterMarkers.tsx
  - src/components/Listings/ListingCard.tsx
  - src/components/Listings/ListingList.tsx
  - src/components/Layout/AppHeader.tsx
  - src/components/Layout/SplitLayout.tsx
  - src/App.tsx
  - src/App.css
  - src/main.tsx
  - src/hooks/useRTL.ts
autonomous: true

must_haves:
  truths:
    - "User sees interactive map showing all of Israel"
    - "Listings appear as clustered pins on the map"
    - "User can click a pin to see popup and highlight listing card"
    - "User sees scrollable listing cards on the right (desktop)"
    - "Header shows app title and language toggle"
    - "Layout switches between RTL (Hebrew) and LTR (English)"
    - "Mobile layout shows map and list stacked vertically"
  artifacts:
    - path: "src/components/Map/LeafletMap.tsx"
      provides: "Interactive map with OpenStreetMap tiles"
      exports: ["LeafletMap"]
      min_lines: 50
    - path: "src/components/Map/ClusterMarkers.tsx"
      provides: "Clustered markers with popup and card sync"
      exports: ["ClusterMarkers"]
      min_lines: 40
    - path: "src/components/Listings/ListingCard.tsx"
      provides: "Individual listing card display"
      exports: ["ListingCard"]
      min_lines: 60
    - path: "src/components/Listings/ListingList.tsx"
      provides: "Scrollable list container for listing cards"
      exports: ["ListingList"]
      min_lines: 30
    - path: "src/components/Layout/AppHeader.tsx"
      provides: "Header with title and language toggle"
      exports: ["AppHeader"]
      min_lines: 30
    - path: "src/components/Layout/SplitLayout.tsx"
      provides: "Responsive map/list split layout"
      exports: ["SplitLayout"]
      min_lines: 20
    - path: "src/hooks/useRTL.ts"
      provides: "RTL/LTR document direction switching"
      exports: ["useRTL"]
      min_lines: 15
  key_links:
    - from: "src/App.tsx"
      to: "src/hooks/useListings.ts"
      via: "Fetch listings data"
      pattern: "useListings"
    - from: "src/App.tsx"
      to: "src/hooks/useRTL.ts"
      via: "Apply RTL layout on language change"
      pattern: "useRTL"
    - from: "src/components/Map/ClusterMarkers.tsx"
      to: "src/components/Listings/ListingCard.tsx"
      via: "Scroll to card on marker click"
      pattern: "scrollIntoView"
    - from: "src/main.tsx"
      to: "leaflet/dist/leaflet.css"
      via: "Import Leaflet CSS"
      pattern: "import.*leaflet\\.css"
---

<objective>
Build complete map and listing UI with interactive Leaflet map, clustered markers, listing cards, bilingual header, and responsive split layout.

Purpose: Enable users to browse rental listings on a map with Hebrew/English UI
Output: Fully functional map-based listing browser with RTL/LTR support
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-frontend-foundation/04-CONTEXT.md
@.planning/phases/04-frontend-foundation/04-RESEARCH.md
@src/App.tsx
@src/main.tsx
@src/types/listing.ts
@src/hooks/useListings.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create map components with clustering</name>
  <files>
    src/components/Map/LeafletMap.tsx
    src/components/Map/ClusterMarkers.tsx
    src/main.tsx
  </files>
  <action>
Create interactive Leaflet map with OpenStreetMap tiles and clustered markers (Patterns 1 and 6 from RESEARCH.md).

**1. Import Leaflet CSS in src/main.tsx (CRITICAL - before React imports):**
Add these imports at the TOP of the file (after './i18n/config' and './lib/leaflet-icons'):
```typescript
import 'leaflet/dist/leaflet.css';
import 'react-leaflet-cluster/dist/assets/MarkerCluster.css';
import 'react-leaflet-cluster/dist/assets/MarkerCluster.Default.css';
```

Per RESEARCH.md Pitfall 1: Missing CSS imports cause blank gray map container. These MUST be imported before any React components render.

**2. Create src/components/Map/LeafletMap.tsx:**
```typescript
import { MapContainer, TileLayer } from 'react-leaflet';
import { ClusterMarkers } from './ClusterMarkers';
import type { Listing } from '../../types/listing';

interface LeafletMapProps {
  listings: Listing[];
  onMarkerClick: (listingId: string) => void;
}

// Israel center and zoom level to show entire country
const ISRAEL_CENTER: [number, number] = [31.5, 34.8];
const ISRAEL_ZOOM = 7;

export function LeafletMap({ listings, onMarkerClick }: LeafletMapProps) {
  return (
    <MapContainer
      center={ISRAEL_CENTER}
      zoom={ISRAEL_ZOOM}
      style={{ height: '100%', width: '100%' }}
      scrollWheelZoom={true}
    >
      <TileLayer
        url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
        attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      />
      <ClusterMarkers listings={listings} onMarkerClick={onMarkerClick} />
    </MapContainer>
  );
}
```

**3. Create src/components/Map/ClusterMarkers.tsx:**
```typescript
import { useRef } from 'react';
import { Marker, Popup } from 'react-leaflet';
import MarkerClusterGroup from 'react-leaflet-cluster';
import type { Marker as LeafletMarker } from 'leaflet';
import type { Listing } from '../../types/listing';

interface ClusterMarkersProps {
  listings: Listing[];
  onMarkerClick: (listingId: string) => void;
}

export function ClusterMarkers({ listings, onMarkerClick }: ClusterMarkersProps) {
  // Filter listings with valid coordinates
  const validListings = listings.filter(
    (listing) => listing.latitude && listing.longitude
  );

  return (
    <MarkerClusterGroup>
      {validListings.map((listing) => (
        <ListingMarker
          key={listing.id}
          listing={listing}
          onMarkerClick={onMarkerClick}
        />
      ))}
    </MarkerClusterGroup>
  );
}

interface ListingMarkerProps {
  listing: Listing;
  onMarkerClick: (listingId: string) => void;
}

function ListingMarker({ listing, onMarkerClick }: ListingMarkerProps) {
  const markerRef = useRef<LeafletMarker>(null);

  const handleClick = () => {
    // Open popup on map
    markerRef.current?.openPopup();

    // Scroll to corresponding listing card
    const cardElement = document.getElementById(`listing-${listing.id}`);
    cardElement?.scrollIntoView({ behavior: 'smooth', block: 'center' });

    // Notify parent for highlighting
    onMarkerClick(listing.id);
  };

  return (
    <Marker
      ref={markerRef}
      position={[listing.latitude!, listing.longitude!]}
      eventHandlers={{ click: handleClick }}
    >
      <Popup>
        <div style={{ minWidth: '150px' }}>
          <p style={{ fontWeight: 'bold', marginBottom: '4px' }}>
            {listing.address}
          </p>
          <p style={{ margin: 0 }}>
            ₪{listing.price.toLocaleString()}/חודש
          </p>
          <p style={{ margin: 0, fontSize: '0.9em', color: '#666' }}>
            {listing.rooms} חדרים · {listing.size_sqm} מ"ר
          </p>
        </div>
      </Popup>
    </Marker>
  );
}
```

**Key design choices:**
- Israel center coordinates (31.5, 34.8) and zoom 7 per CONTEXT.md
- MarkerClusterGroup wraps all markers for performance per RESEARCH.md
- Marker click opens popup AND scrolls to card (Pattern 6)
- Popup shows brief summary (address, price, rooms, size)
- Filter valid coordinates before rendering (city lookup may miss some cities)
  </action>
  <verify>
1. grep "import.*leaflet/dist/leaflet.css" src/main.tsx shows CSS import
2. cat src/components/Map/LeafletMap.tsx shows MapContainer with Israel center
3. cat src/components/Map/ClusterMarkers.tsx shows MarkerClusterGroup and scrollIntoView
4. grep "scrollIntoView" src/components/Map/ClusterMarkers.tsx confirms card sync
  </verify>
  <done>LeafletMap and ClusterMarkers components created with OpenStreetMap, clustering, and card scroll sync</done>
</task>

<task type="auto">
  <name>Task 2: Create listing card and list components</name>
  <files>
    src/components/Listings/ListingCard.tsx
    src/components/Listings/ListingList.tsx
  </files>
  <action>
Create listing card and scrollable list components per CONTEXT.md specifications.

**1. Create src/components/Listings/ListingCard.tsx:**
```typescript
import { useTranslation } from 'react-i18next';
import type { Listing } from '../../types/listing';

interface ListingCardProps {
  listing: Listing;
  highlighted?: boolean;
}

export function ListingCard({ listing, highlighted }: ListingCardProps) {
  const { t } = useTranslation('common');

  // Use first photo or placeholder
  const photoUrl = listing.photos[0] || 'https://via.placeholder.com/150x100?text=No+Photo';

  return (
    <div
      id={`listing-${listing.id}`}
      className={`listing-card ${highlighted ? 'highlighted' : ''}`}
    >
      <img
        src={photoUrl}
        alt={listing.address}
        className="listing-photo"
      />
      <div className="listing-details">
        <div className="listing-price">
          {t('listing.price', { price: listing.price.toLocaleString() })}
        </div>
        <div className="listing-specs">
          <span>{t('listing.rooms', { count: listing.rooms })}</span>
          {listing.size_sqm && (
            <span> · {t('listing.sqm', { size: listing.size_sqm })}</span>
          )}
          {listing.floor !== null && (
            <span> · {t('listing.floor', { floor: listing.floor })}</span>
          )}
        </div>
        <div className="listing-address">
          {listing.address}, {listing.city}
        </div>
        {listing.description && (
          <div className="listing-description">
            {listing.description.slice(0, 150)}
            {listing.description.length > 150 ? '...' : ''}
          </div>
        )}
      </div>
    </div>
  );
}
```

**2. Create src/components/Listings/ListingList.tsx:**
```typescript
import { useTranslation } from 'react-i18next';
import { ListingCard } from './ListingCard';
import type { Listing } from '../../types/listing';

interface ListingListProps {
  listings: Listing[];
  highlightedId: string | null;
  loading: boolean;
  error: Error | null;
}

export function ListingList({ listings, highlightedId, loading, error }: ListingListProps) {
  const { t } = useTranslation('common');

  if (loading) {
    return (
      <div className="listing-list-status">
        {t('map.loading')}
      </div>
    );
  }

  if (error) {
    return (
      <div className="listing-list-status error">
        {error.message}
      </div>
    );
  }

  if (listings.length === 0) {
    return (
      <div className="listing-list-status">
        {t('map.noListings')}
      </div>
    );
  }

  return (
    <div className="listing-list">
      {listings.map((listing) => (
        <ListingCard
          key={listing.id}
          listing={listing}
          highlighted={listing.id === highlightedId}
        />
      ))}
    </div>
  );
}
```

**Design notes per CONTEXT.md:**
- Card shows: photo thumbnail, price, rooms, sqm, address + city, floor
- Description truncated to 150 chars
- Highlighted state for marker click sync
- Loading/error/empty states with i18n
- Source badges deferred (only Yad2 exists, revisit in Phase 7)
  </action>
  <verify>
1. cat src/components/Listings/ListingCard.tsx shows listing-card with photo and details
2. grep "useTranslation" src/components/Listings/ListingCard.tsx shows i18n usage
3. cat src/components/Listings/ListingList.tsx shows loading/error/empty states
4. grep "highlighted" src/components/Listings/ListingCard.tsx confirms highlight prop
  </verify>
  <done>ListingCard and ListingList components created with i18n, photos, specs, and highlight support</done>
</task>

<task type="auto">
  <name>Task 3: Create layout components and wire everything together</name>
  <files>
    src/components/Layout/AppHeader.tsx
    src/components/Layout/SplitLayout.tsx
    src/hooks/useRTL.ts
    src/App.tsx
    src/App.css
  </files>
  <action>
Create header, layout, RTL hook, and wire all components in App.tsx.

**1. Create src/hooks/useRTL.ts (Pattern 4 from RESEARCH.md):**
```typescript
import { useEffect } from 'react';
import { useTranslation } from 'react-i18next';

/**
 * Hook to sync document direction with i18next language
 * Switches between RTL (Hebrew) and LTR (English)
 */
export function useRTL() {
  const { i18n } = useTranslation();

  useEffect(() => {
    // i18n.dir() returns 'rtl' for Hebrew, 'ltr' for English
    const dir = i18n.dir();
    document.documentElement.dir = dir;
    document.documentElement.lang = i18n.language;
  }, [i18n.language, i18n]);
}
```

**2. Create src/components/Layout/AppHeader.tsx:**
```typescript
import { useTranslation } from 'react-i18next';

export function AppHeader() {
  const { t, i18n } = useTranslation('common');

  const toggleLanguage = () => {
    const newLang = i18n.language === 'he' ? 'en' : 'he';
    i18n.changeLanguage(newLang);
  };

  return (
    <header className="app-header">
      <h1 className="app-title">{t('header.title')}</h1>
      <button onClick={toggleLanguage} className="language-toggle">
        {t('header.languageToggle')}
      </button>
    </header>
  );
}
```

**3. Create src/components/Layout/SplitLayout.tsx:**
```typescript
import { ReactNode } from 'react';

interface SplitLayoutProps {
  mapContent: ReactNode;
  listContent: ReactNode;
}

export function SplitLayout({ mapContent, listContent }: SplitLayoutProps) {
  return (
    <div className="split-layout">
      <div className="map-panel">{mapContent}</div>
      <div className="list-panel">{listContent}</div>
    </div>
  );
}
```

**4. Update src/App.tsx:**
```typescript
import { useState } from 'react';
import { AppHeader } from './components/Layout/AppHeader';
import { SplitLayout } from './components/Layout/SplitLayout';
import { LeafletMap } from './components/Map/LeafletMap';
import { ListingList } from './components/Listings/ListingList';
import { useListings } from './hooks/useListings';
import { useRTL } from './hooks/useRTL';
import './App.css';

function App() {
  const { listings, loading, error } = useListings();
  const [highlightedId, setHighlightedId] = useState<string | null>(null);

  // Apply RTL layout on language change
  useRTL();

  const handleMarkerClick = (listingId: string) => {
    setHighlightedId(listingId);
    // Clear highlight after 2 seconds
    setTimeout(() => setHighlightedId(null), 2000);
  };

  return (
    <div className="app">
      <AppHeader />
      <SplitLayout
        mapContent={
          <LeafletMap
            listings={listings}
            onMarkerClick={handleMarkerClick}
          />
        }
        listContent={
          <ListingList
            listings={listings}
            highlightedId={highlightedId}
            loading={loading}
            error={error}
          />
        }
      />
    </div>
  );
}

export default App;
```

**5. Replace src/App.css with responsive layout styles:**
```css
/* Reset and base */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

.app {
  display: flex;
  flex-direction: column;
  height: 100vh;
  overflow: hidden;
}

/* Header */
.app-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 1.5rem;
  background-color: #2c3e50;
  color: white;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.app-title {
  font-size: 1.5rem;
  font-weight: 600;
}

.language-toggle {
  padding: 0.5rem 1rem;
  background-color: #3498db;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 1rem;
}

.language-toggle:hover {
  background-color: #2980b9;
}

/* Split layout - Desktop */
.split-layout {
  display: flex;
  flex: 1;
  overflow: hidden;
}

.map-panel {
  flex: 0 0 60%; /* 60% width per CONTEXT.md */
  height: 100%;
}

.list-panel {
  flex: 1;
  height: 100%;
  overflow-y: auto;
  background-color: #f5f5f5;
  padding: 1rem;
}

/* Listing list */
.listing-list {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.listing-list-status {
  text-align: center;
  padding: 2rem;
  color: #666;
  font-size: 1.1rem;
}

.listing-list-status.error {
  color: #e74c3c;
}

/* Listing card */
.listing-card {
  display: flex;
  gap: 1rem;
  background: white;
  border-radius: 8px;
  padding: 1rem;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  transition: box-shadow 0.2s, transform 0.2s;
  cursor: pointer;
}

.listing-card:hover {
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  transform: translateY(-2px);
}

.listing-card.highlighted {
  box-shadow: 0 0 0 3px #3498db;
  transform: scale(1.02);
}

.listing-photo {
  width: 150px;
  height: 100px;
  object-fit: cover;
  border-radius: 4px;
  flex-shrink: 0;
}

.listing-details {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.listing-price {
  font-size: 1.3rem;
  font-weight: 700;
  color: #2c3e50;
}

.listing-specs {
  color: #555;
  font-size: 0.95rem;
}

.listing-address {
  font-weight: 500;
  color: #333;
}

.listing-description {
  font-size: 0.9rem;
  color: #666;
  line-height: 1.4;
}

/* Mobile layout */
@media (max-width: 768px) {
  .split-layout {
    flex-direction: column;
  }

  .map-panel {
    flex: 0 0 50vh; /* 50% of viewport height per RESEARCH.md */
  }

  .list-panel {
    flex: 1;
  }

  .listing-card {
    flex-direction: column;
  }

  .listing-photo {
    width: 100%;
    height: 200px;
  }
}

/* RTL adjustments using logical properties */
[dir="rtl"] .listing-card {
  text-align: start;
}

/* Leaflet popup RTL fix */
[dir="rtl"] .leaflet-popup-content {
  text-align: right;
}
```

**Design notes:**
- Minimal header with title + toggle per CONTEXT.md
- Desktop: 60% map, 40% list split
- Mobile: 50vh map, rest list (vertical stack)
- CSS logical properties for RTL compatibility
- Highlight animation for marker click sync
- Clean, modern card style (Claude's discretion)
  </action>
  <verify>
1. cat src/hooks/useRTL.ts shows document.documentElement.dir assignment
2. cat src/components/Layout/AppHeader.tsx shows language toggle button
3. cat src/App.tsx shows useListings, useRTL, and component wiring
4. grep "split-layout" src/App.css shows responsive layout styles
5. grep "@media.*768px" src/App.css shows mobile breakpoint
  </verify>
  <done>All layout components, RTL hook, and App.tsx wired together with responsive CSS</done>
</task>

</tasks>

<verification>
1. All components exist: `ls src/components/Map/ src/components/Listings/ src/components/Layout/`
2. Leaflet CSS imported: `grep "leaflet/dist/leaflet.css" src/main.tsx`
3. App.tsx uses all hooks: `grep -E "useListings|useRTL" src/App.tsx`
4. App.css contains responsive layout: `grep "split-layout" src/App.css`
5. No TypeScript errors: `npm run build` succeeds
6. Dev server runs: `npm run dev` starts without errors
</verification>

<success_criteria>
- [ ] src/components/Map/LeafletMap.tsx renders MapContainer with Israel bounds
- [ ] src/components/Map/ClusterMarkers.tsx renders MarkerClusterGroup with popups
- [ ] src/components/Listings/ListingCard.tsx shows photo, price, specs, address
- [ ] src/components/Listings/ListingList.tsx handles loading/error/empty states
- [ ] src/components/Layout/AppHeader.tsx has title and language toggle
- [ ] src/components/Layout/SplitLayout.tsx creates 60/40 desktop split
- [ ] src/hooks/useRTL.ts switches document direction on language change
- [ ] src/App.tsx wires all components with useListings and useRTL
- [ ] src/App.css provides responsive layout and RTL support
- [ ] src/main.tsx imports Leaflet CSS before React components
- [ ] npm run build completes without errors
- [ ] npm run dev starts and shows map + listings
</success_criteria>

<output>
After completion, create `.planning/phases/04-frontend-foundation/04-03-SUMMARY.md`
</output>
